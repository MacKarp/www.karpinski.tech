---
title: "Domowy serwerk"
date: 2023-02-05T12:24:36+01:00
tags:
  - Linux
  - Networking
  - Nextcloud
  - Collegium Witelona
draft: false
---

Projekt domowego serwera chodziÅ‚ mi po gÅ‚owie juÅ¼ od dÅ‚uÅ¼szego czasu, ale z rÃ³Å¼nych powodÃ³w ciÄ…gle go odkÅ‚adaÅ‚em na pÃ³Åºniej. Projekt w koÅ„cu zrealizowaÅ‚em w 2021/2022 na potrzeby pracy dyplomowej, ktÃ³rej celem byÅ‚a budowa domowego serwera multimediÃ³w i plikÃ³w. Promotorem pracy byÅ‚ dr inÅ¼. Zbigniew FryÅºlewicz.

Wymagania pracy dyplomowej:
 - System operacyjny: Linux
 - Serwer multimediÃ³w (strumieniowanie muzyki/filmÃ³w)
 - Serwer e-bookÃ³w
 - Serwer plikÃ³w z moÅ¼liwoÅ›ciÄ… konwersji audio i wideo

## Hardware
ChciaÅ‚em, Å¼eby urzÄ…dzenie byÅ‚o w miarÄ™ kompaktowe i energooszczÄ™dne, wiÄ™c poczÄ…tkowo rozglÄ…daÅ‚em siÄ™ za pÅ‚ytami gÅ‚Ã³wnymi w formacie mini i nano ITX, ale wtedy trafiÅ‚em na kilka artykuÅ‚Ã³w i filmÃ³w przedstawiajÄ…cych realizacjÄ™ podobnych projektÃ³w na RaspberryPi. WczeÅ›niej nie miaÅ‚em okazji â€pobawiÄ‡â€ siÄ™ [SBC](https://en.wikipedia.org/wiki/Single-board_computer) â€“ zawsze uwaÅ¼aÅ‚em je za gadÅ¼et wiÄ™c i nie wiedziaÅ‚em jak bardzo pod wzglÄ™dem moÅ¼liwoÅ›ci rozwinÄ™Å‚a siÄ™ ta czÄ™Å›Ä‡ IT. WybÃ³r SBC powodowaÅ‚, Å¼e jednoczeÅ›nie miaÅ‚em zaÅ‚atwionÄ… kwestiÄ™ niskiego zuÅ¼ycia energii i zachowania kompaktowych wymiarÃ³w, z drugiej strony SBC czÄ™sto wykorzystujÄ… procesory o architekturze ARM a ta poza telefonami z androidem byÅ‚a dla mnie zupeÅ‚nie nieznana. Zmiana architektury nie byÅ‚aby dla mnie minus a wrÄ™cz plusem, w koÅ„cu mÃ³gÅ‚bym zrobiÄ‡ coÅ› nowego niÅ¼ zÅ‚oÅ¼enie kolejnego zestawu na x86-64, poprzedni raz takÄ… zmianÄ™ w architekturze dokonaÅ‚em w okolicach 2000r gdzie przesiadÅ‚em siÄ™ z Amigi 600 na PC. DuÅ¼ym minusem wszystkich SBC, jakie oglÄ…daÅ‚em byÅ‚a maÅ‚a liczba (max 2) lub caÅ‚kowity brak portÃ³w SATA, co uniemoÅ¼liwiaÅ‚o utworzenie sensownej macierzy dyskowej, a ktÃ³rÄ… mimo braku w wymaganiach chciaÅ‚em mieÄ‡. SzukajÄ…c informacji jak sensownie podÅ‚Ä…czyÄ‡ (nie przez USB!) wiÄ™kszÄ… iloÅ›Ä‡ dyskÃ³w trafiÅ‚em na SBC [RockPi4](https://wiki.radxa.com/Rock4)  i nakÅ‚adki [Quad i Penta SATA Kit](https://wiki.radxa.com/SATA_HAT), obie nakÅ‚adki pozwalajÄ… na podÅ‚Ä…czenie 4 dyskÃ³w(5 w przypadku Penta) co juÅ¼ pozwala na utworzenie macierzy RAID 5, a to juÅ¼ mnie zadowalaÅ‚o. Kolejnym elementem byÅ‚ wybÃ³r twardych dyskÃ³w, chciaÅ‚em, Å¼eby byÅ‚y to dyski 2,5â€ i Å¼eby cena za 1GB byÅ‚a jak najmniejsza. WybÃ³r padÅ‚ wiÄ™c na dedykowane dla systemÃ³w NAS dyski [WD Red Plus](https://www.westerndigital.com/pl-pl/products/internal-drives/wd-red-plus-sata-2-5-hdd#WD10JFCX) o pojemnoÅ›ci 1TB z myÅ›lÄ… o przyszÅ‚ej wymianie na pojemniejsze dyski SSD â€“ gdy ich ceny bÄ™dÄ… korzystniejsze.

Do realizacji projektu wybraÅ‚em: 
 - Rock Pi 4 Model A z 4GB RAM
 - Penta SATA KIT
 - ModuÅ‚ eMMC 64GB
 - 4x  NAS WD Redâ„¢ Plus 2,5â€ WD10JFCX 

![schemat hardware](/images/2023-thumbs/02.serwer/hardware.png#center)

## Software
Wymagania pracy byÅ‚y dosyÄ‡ jasne wystarczyÅ‚o wiÄ™c tylko dobraÄ‡ odpowiednie oprogramowanie. Do realizacji wykorzystaÅ‚em:
 - [Armbian Buster](https://www.armbian.com/rockpi4/)
 - [Docker](https://www.docker.com/)
 - [Jellyfin](https://jellyfin.org/)
 - [Calibre](https://calibre-ebook.com/)
 - [Nextcloud](https://nextcloud.com/) + [Collabora](https://www.collaboraoffice.com/) + wtyczki do konwersji [wideo](https://apps.nextcloud.com/apps/video_converter) i bazujÄ…cej na niej [audio](https://github.com/MacKarp/NextcloudAudio_Converter)

Kontenery zostaÅ‚y utworzone na podstawie konfiguracji dostÄ™pnych w [repozytorium](https://github.com/MacKarp/HomeServerConfig)

![schemat software](/images/2023-thumbs/02.serwer/software.png#center)

## MontaÅ¼
Po otrzymaniu wszystkich zamÃ³wionych podzespoÅ‚Ã³w zabraÅ‚em siÄ™ za montaÅ¼, ktÃ³ry przebiegÅ‚ bez â€“ jak poczÄ…tkowo myÅ›laÅ‚em â€“ najmniejszego problemu. Na etapie konfiguracji systemu operacyjnego okazaÅ‚o siÄ™, Å¼e nie dziaÅ‚a wyÅ›wietlacz w TOP HAT, po zbadaniu sprawy wyszÅ‚o, Å¼e doÅ‚Ä…czony zostaÅ‚ nieprawidÅ‚owy kabelek Å‚Ä…czÄ…cy SATA HAT i TOP HAT (Tematy [1](https://forum.radxa.com/t/quad-sata-hat-top-no-oled-display-information-or-push-button-action/3478) i [2](https://forum.radxa.com/t/penta-top-hat-oled-not-working/6060)), ktÃ³ry przepaliÅ‚ wyÅ›wietlacz  po otrzymaniu prawidÅ‚owego kabelka i nowej TOP HAT wszystko zadziaÅ‚aÅ‚o. 

![serwerek](/images/2023-thumbs/02.serwer/serwerek.png#center)


## Konfiguracja systemu operacyjnego
System Armbian zostaÅ‚ zainstalowany na module eMMC, na dyskach HDD utworzyÅ‚em macierz RAIDZ â€“ odpowiednik RAID 5 z systemem plikÃ³w ZFS. TrochÄ™ czasu zajÄ™Å‚o mi odpowiednie doszlifowanie plikÃ³w z konfiguracjÄ… dla Docker Compose, skonfigurowanie wszystkich aplikacji na potrzeby prezentacji pracy i zabezpieczenie serwera gdzie pomocny byÅ‚ artykuÅ‚ [How to Secure A Web Server](https://christitus.com/secure-web-server/) i ksiÄ…Å¼ka  [Unix i Linux Przewodnik administratora systemÃ³w](https://lubimyczytac.pl/ksiazka/4929896/unix-i-linux-przewodnik-administratora-systemow-wydanie-v). Po zabezpieczeniu utworzyÅ‚em w moim routerze TP-Link przekierowania na odpowiednie porty i ustawiÅ‚em domenÄ™ DDNS. Jedynie czego mi brakowaÅ‚o to uruchomienie szyfrowania SSL w usÅ‚ugach, szukajÄ…c informacji jak najlepiej to zrobiÄ‡ i kilka nieudanych prÃ³b spowodowaÅ‚o, Å¼e musiaÅ‚em pomysÅ‚ zarzuciÄ‡ â€” poÅ‚Ä…czenie pracy zawodowej, zbliÅ¼ajÄ…cego siÄ™ terminu oddania pracy dyplomowej i realizacja projektu na zaliczenie przedmiotu Programowanie urzÄ…dzeÅ„ mobilnych sprawiÅ‚o, Å¼e nie miaÅ‚em juÅ¼ wiÄ™cej czasu na doszlifowanie tego brakujÄ…cego elementu (jak siÄ™ pÃ³Åºniej okazaÅ‚o, to byÅ‚o bardzo Å‚atwe i szybkie do realizacji!).

ObronÄ™ pracy dyplomowej zaliczyÅ‚em na 5!ğŸ¥³

## Dalsze losy serwera
Po obronie pracy dyplomowej zgodnie z zaleceniem promotora serwer w obecnej konfiguracji pracowaÅ‚ jeszcze 3 miesiÄ…ce, po ktÃ³rych upÅ‚ywie zaoraÅ‚em wszystko. Debian, na ktÃ³rym bazowaÅ‚ Armbian choÄ‡ stabilny to jednak posiada starszÄ… wersjÄ™ pakietÃ³w, chciaÅ‚em czegoÅ› â€nowszegoâ€. BazujÄ…c na rÃ³Å¼nych ÅºrÃ³dÅ‚ach prÃ³bowaÅ‚em uruchomiÄ‡ Fedora Server, ale niestety po paru dniach walk nie udaÅ‚o mi siÄ™, przywrÃ³ciÅ‚em kopiÄ™ Armbiana na eMMC i uruchomiÅ‚em jedynie kontener z Nextcloud. MajÄ…c wolny czas szukaÅ‚em informacji jak uruchomiÄ‡ szyfrowanie SSL i testujÄ…c rÃ³Å¼ne rozwiÄ…zania w  koÅ„cu trafiÅ‚em na projekt [Nginx Proxy Manager](https://nginxproxymanager.com/)! Po jego uruchomieniu jako kontener dockerowy wystarczy tylko go skonfigurowaÄ‡ i zmieniÄ‡ parÄ™ opcji w ustawieniach kontenera Nextcloud a wszystkie problemy z SSL jakie miaÅ‚em same siÄ™ rozwiÄ…zaÅ‚y! Proste i skuteczne rozwiÄ…zanie, przy ktÃ³rym spÄ™dziÅ‚em jeden wieczÃ³r. Kolejnym kontenerem, jaki dodaÅ‚em, a na ktÃ³ry trafiÅ‚em zupeÅ‚nie przypadkiem jest [Portainer](https://www.portainer.io/) co bardzo uÅ‚atwia mi Å¼ycie przy zarzÄ…dzaniu ğŸ˜„

## Przygoda z snapshotami ZFS
Wszystko dziaÅ‚aÅ‚o piÄ™knie, ale po jakimÅ› czasie zauwaÅ¼yÅ‚em, Å¼e mam coraz mniej dostÄ™pnego miejsca na serwerku z 3TB zostaÅ‚o niecaÅ‚e 150GB, postanowiÅ‚em trochÄ™ posprzÄ…taÄ‡ â€“ myÅ›lÄ…c, Å¼e pewnie automatyczne kopie kilku moich PC zaszalaÅ‚y i spuchÅ‚y ğŸ˜‰, jakie byÅ‚o moje zdziwienie, gdy po usuniÄ™ciu niektÃ³rych danych iloÅ›Ä‡ wolnego miejsca jeszcze zmalaÅ‚a! BadajÄ…c temat znalazÅ‚em przyczynÄ™, moja macierz ZFS ma ponad 13000 snapshotÃ³w! Po krÃ³tkiej konsultacji na Reedicie (Tematy [1](https://www.reddit.com/r/zfs/comments/xudiih/raidz_running_out_of_space_bad_configuration/) i [2](https://www.reddit.com/r/zfs/comments/yc8gu3/cant_remove_dataset_is_busysnapshot_are_cloned/)) zrobiÅ‚em odpowiedniÄ… konfiguracje i prostym skrypcikiem udaÅ‚o mi siÄ™ temat ogarnÄ…Ä‡ ğŸ˜„ najwyraÅºniej moje zabawy sprawiÅ‚y, Å¼e docker sobie potworzyÅ‚ wiele  zbÄ™dnych snapshotÃ³w poÅ¼erajÄ…c caÅ‚e miejsce ğŸ˜„

## Dalsze plany
ChciaÅ‚bym zmigrowaÄ‡ swojÄ… instancjÄ™ Nextcloud na kontener [AIO](https://github.com/nextcloud/all-in-one) oraz dodaÄ‡ do niego Proton Bridge, aby przekonfigurowaÄ‡ wysyÅ‚kÄ™ maili z gmaila na mojÄ… domenÄ™ w proton mail.